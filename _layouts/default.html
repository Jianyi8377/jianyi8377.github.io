<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

{%- include head.html -%}

<body>

  {%- include header.html -%}

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      {{ content }} <!-- 嵌入页面内容（首页/文章），不会被覆盖 -->
    </div>
  </main>

  {%- include footer.html -%}

  <!-- 音乐播放器组件（公共部分，所有页面都有） -->
  <style>
    /* 音乐组件样式（保持不变） */
    .music-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999 !important;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .music-control {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #3498db;
      color: white;
      border: none !important;
      font-size: 20px;
      cursor: pointer !important;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .music-control:hover {
      background-color: #2980b9;
      transform: scale(1.1);
    }
    .progress-container {
      width: 280px;
      background-color: rgba(255, 255, 255, 0.98);
      border-radius: 10px 10px 0 0;
      padding: 10px 15px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 5px;
      display: none;
    }
    .music-list {
      width: 280px;
      background-color: rgba(255, 255, 255, 0.98);
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      margin-bottom: 5px;
    }
    .music-container.show .progress-container,
    .music-container.show .music-list {
      display: block;
    }
    .music-list-title {
      color: #2c3e50;
      font-size: 0.9em;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    .music-item {
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-size: 0.9em;
    }
    .music-item:hover, .music-item.active {
      background-color: #e3f2fd;
      color: #2980b9;
      font-weight: 500;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background-color: #eee;
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }
    .progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background-color: #3498db;
      border-radius: 3px;
      width: 0%;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.75em;
      color: #7f8c8d;
      margin-top: 5px;
    }
    audio { display: none !important; }
    @media (max-width: 768px) {
      .music-container { bottom: 15px; right: 15px; }
      .music-control { width: 55px; height: 55px; font-size: 22px; }
      .music-list, .progress-container { width: 260px; }
    }
    @media (max-width: 480px) {
      .music-list, .progress-container { width: 240px; max-height: 250px; }
    }
  </style>

  <audio id="bgm" loop preload="metadata">
    <source src="/music/我的一个道姑朋友.mp3" type="audio/mpeg">
    <p>你的浏览器不支持音频播放，请升级浏览器。</p>
   ></audio>

  <div class="music-container" id="musicContainer">
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="time-display">
        <span id="currentTime">00:00</span>
        <span id="totalTime">00:00</span>
      </div>
    </div>
    <div class="music-list" id="musicList">
      <div class="music-list-title">歌曲列表</div>
    </div>
    <button class="music-control" id="musicBtn">▶️</button>
  </div>

  <script>
    // 歌曲配置
    let musicList = [
      { name: "我的一个道姑朋友", url: "/music/我的一个道姑朋友.mp3" },
      { name: "童年", url: "/music/童年.mp3" },
    ];

    const bgm = document.getElementById('bgm');
    const musicBtn = document.getElementById('musicBtn');
    const musicContainer = document.getElementById('musicContainer');
    const musicListEl = document.getElementById('musicList');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');

    let isPlaying = false;
    let currentMusicIndex = 0;
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    let isDragging = false;
    let hasInteracted = false; // 标记用户是否在当前页面有过交互

    // 保存播放状态到本地存储
    function savePlayState() {
      localStorage.setItem('musicIsPlaying', isPlaying);
      localStorage.setItem('musicCurrentIndex', currentMusicIndex);
      localStorage.setItem('musicCurrentTime', bgm.currentTime);
    }

    // 从本地存储恢复播放状态（恢复歌曲、进度，不自动播放）
    function restorePlayState() {
      const savedIsPlaying = localStorage.getItem('musicIsPlaying') === 'true';
      const savedIndex = parseInt(localStorage.getItem('musicCurrentIndex'));
      const savedTime = parseFloat(localStorage.getItem('musicCurrentTime'));

      // 恢复歌曲和进度
      if (!isNaN(savedIndex) && savedIndex >= 0 && savedIndex < musicList.length) {
        currentMusicIndex = savedIndex;
        bgm.src = musicList[currentMusicIndex].url;

        bgm.addEventListener('loadedmetadata', () => {
          if (!isNaN(savedTime) && savedTime > 0 && savedTime < bgm.duration) {
            bgm.currentTime = savedTime; // 恢复到之前的进度
          }
          updateProgress();
        });
      }

      // 恢复UI状态（之前是播放中，则按钮显示暂停图标）
      if (savedIsPlaying) {
        musicBtn.innerHTML = "⏸️";
        isPlaying = true; // 标记为“待播放”状态
      }
    }

    // 核心新增：监听页面首次交互，触发自动播放
    function listenFirstInteraction() {
      // 监听多种交互事件（点击、触摸、滑动、按键）
      const interactionEvents = [
        'click', 'touchstart', 'mousemove', // 基础交互
        'scroll', 'keydown' // 滑动、按键也视为交互
      ];

      // 交互触发函数
      function handleFirstInteraction() {
        if (hasInteracted || !isPlaying) return; // 已交互过或无需播放，直接返回

        // 触发自动播放（此时有用户交互，浏览器不会拦截）
        bgm.play().then(() => {
          console.log('用户交互后自动续播成功');
        }).catch(err => {
          console.log('续播失败（罕见）：', err);
          musicBtn.innerHTML = "▶️";
          isPlaying = false;
        });

        hasInteracted = true; // 标记为已交互，避免重复触发
        // 移除所有监听（避免性能消耗）
        interactionEvents.forEach(event => {
          document.removeEventListener(event, handleFirstInteraction);
        });
      }

      // 绑定所有交互事件（只触发一次）
      interactionEvents.forEach(event => {
        document.addEventListener(event, handleFirstInteraction, { once: true });
      });
    }

    // 初始化播放器
    function initMusicPlayer() {
      if (musicList.length === 0) {
        musicListEl.innerHTML = '<div class="no-music-tip">暂无歌曲</div>';
        musicBtn.disabled = true;
        musicBtn.style.backgroundColor = '#bdc3c7';
        return;
      }

      // 生成歌曲列表
      let listHtml = '<div class="music-list-title">歌曲列表</div>';
      musicList.forEach((music, index) => {
        listHtml += `<div class="music-item ${index === currentMusicIndex ? 'active' : ''}" data-index="${index}">${music.name}</div>`;
      });
      musicListEl.innerHTML = listHtml;

      // 绑定事件
      document.querySelectorAll('.music-item').forEach(item => {
        item.addEventListener('click', () => switchMusic(parseInt(item.dataset.index)));
      });
      musicBtn.addEventListener('click', togglePlay);

      // 列表显示逻辑
      if (isMobile) {
        musicBtn.addEventListener('click', () => {
          setTimeout(() => musicContainer.classList.toggle('show'), 100);
        });
        document.addEventListener('click', (e) => {
          if (!musicContainer.contains(e.target) && musicContainer.classList.contains('show')) {
            musicContainer.classList.remove('show');
          }
        });
      } else {
        musicContainer.addEventListener('mouseenter', () => musicContainer.classList.add('show'));
        musicContainer.addEventListener('mouseleave', () => musicContainer.classList.remove('show'));
      }

      // 进度条事件
      progressBar.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);
      progressBar.addEventListener('touchstart', startDrag, { passive: false });
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('touchend', endDrag);

      // 音频事件
      bgm.addEventListener('timeupdate', () => {
        updateProgress();
        if (isPlaying && Math.floor(bgm.currentTime) % 3 === 0) {
          savePlayState();
        }
      });
      bgm.addEventListener('loadedmetadata', updateProgress);
      bgm.addEventListener('ended', () => {
        if (musicList.length > 1) nextSong();
        savePlayState();
      });
      bgm.addEventListener('error', () => {
        alert(`歌曲 "${musicList[currentMusicIndex].name}" 加载失败，请检查路径！`);
        if (musicList.length > 1) nextSong();
        savePlayState();
      });

      // 1. 恢复之前的播放状态
      restorePlayState();
      // 2. 监听首次交互，自动续播
      listenFirstInteraction();
    }

    // 播放/暂停控制
    function togglePlay() {
      if (musicList.length === 0) return;

      if (isPlaying && bgm.paused) {
        // 待播放状态 → 播放
        bgm.play().catch(err => {
          alert('需点击页面授权音频，授权后自动播放～');
          document.addEventListener('click', () => {
            bgm.play().then(() => {
              musicBtn.innerHTML = "⏸️";
              isPlaying = true;
              hasInteracted = true;
            }).catch(() => {});
          }, { once: true });
        });
      } else if (isPlaying) {
        // 播放中 → 暂停
        bgm.pause();
        musicBtn.innerHTML = "▶️";
        isPlaying = false;
      } else {
        // 暂停 → 播放
        bgm.play().catch(err => {
          alert('需点击页面授权音频，授权后自动播放～');
          document.addEventListener('click', () => {
            bgm.play().then(() => {
              musicBtn.innerHTML = "⏸️";
              isPlaying = true;
              hasInteracted = true;
            }).catch(() => {});
          }, { once: true });
        });
        musicBtn.innerHTML = "⏸️";
        isPlaying = true;
      }
      savePlayState();
    }

    // 切换歌曲
    function switchMusic(index) {
      currentMusicIndex = index;
      bgm.src = musicList[currentMusicIndex].url;
      document.querySelectorAll('.music-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });
      if (isPlaying) bgm.play();
      savePlayState();
    }

    // 下一首
    function nextSong() {
      if (musicList.length <= 1) return;
      currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
      switchMusic(currentMusicIndex);
    }

    // 进度条更新
    function updateProgress() {
      if (isNaN(bgm.duration)) return;
      const percent = (bgm.currentTime / bgm.duration) * 100;
      progressFill.style.width = `${percent}%`;
      currentTimeEl.textContent = formatTime(bgm.currentTime);
      totalTimeEl.textContent = formatTime(bgm.duration);
    }

    // 时间格式化
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // 拖动进度条
    function startDrag(e) {
      if (isNaN(bgm.duration)) return;
      isDragging = true;
      updateProgressFromEvent(e);
      e.preventDefault();
    }
    function drag(e) {
      if (isDragging && !isNaN(bgm.duration)) updateProgressFromEvent(e);
    }
    function endDrag() {
      isDragging = false;
      savePlayState();
    }
    function updateProgressFromEvent(e) {
      const rect = progressBar.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const relativeX = Math.max(0, Math.min(clientX - rect.left, rect.width));
      const percent = relativeX / rect.width;
      bgm.currentTime = percent * bgm.duration;
      updateProgress();
    }

    // 页面加载初始化
    window.addEventListener('load', initMusicPlayer);

    // 页面关闭/刷新时保存状态
    window.addEventListener('beforeunload', savePlayState);
  </script>

</body>
</html>